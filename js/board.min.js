var firefoxAgent=window.navigator.userAgent.indexOf("Firefox")>-1,chromeAgent=window.navigator.userAgent.indexOf("Chrome")>-1,is_practice=document.getElementById("is_practice").value,is_admin=document.getElementById("is_admin").value,grid_offset_xy=parseInt(document.getElementById("scorebd_xy_offset").value),player_panel_wh=parseInt(document.getElementById("player_panel_wh").value),player_hand_xy_offset=parseInt(document.getElementById("player_hand_xy_offset").value),tiles_left_offset=parseInt(document.getElementById("tiles_left_offset").value),tile_points_offX=parseInt(document.getElementById("tile_points_offX").value),tile_points_offY=parseInt(document.getElementById("tile_points_offY").value),current_player=document.getElementById("current_player").value,ws_port=document.getElementById("ws_port").value,URL_x=null,AppSpace=null,Scale=1,ChatWin=null,ChatDoc=null,Chat=null,chat_width=300,chat_height=600,BookMKWin=null,BookMKDoc=null,BookMK=null,BookMK_width=300,BookMK_height=600;const NUM_ROWS_COLS=15,CELL_SIZE=35,GRID_SIZE=525,SAFETY_FILL="rgba(68,187,85,1)",SAFETY_FILL_LITE="rgba(68,187,85,.3)",SAFE_INDEXES=[{row:1,col:1,rect:null},{row:1,col:15,rect:null},{row:2,col:2,rect:null},{row:2,col:14,rect:null},{row:15,col:1,rect:null},{row:15,col:15,rect:null},{row:14,col:2,rect:null},{row:14,col:14,rect:null},{row:1,col:Math.round(7.5),rect:null},{row:Math.round(7.5),col:1,rect:null},{row:Math.round(7.5),col:15,rect:null},{row:15,col:Math.round(7.5),rect:null}],NUM_PLAYER_TILES=7,RECT_POSITION=0,TEXT_POSITION=6,POINTS_POSITION=7,BLANK_TILE="WILD",char_regex=/^([a-r]|[t-z]){1}$|^([A-R]|[T-Z]){1}$/,back_ground="#f5efe6ff";var scoreboard=null;class Tile{constructor(e,t,l,n,i){this.id=e.getAttributeNS(null,"id"),this.char=e.childNodes[6].textContent,this.points=i||parseInt(e.childNodes[7].textContent),this.row=Math.round(e.getAttributeNS(null,"y")/35)+1,this.column=Math.round(e.getAttributeNS(null,"x")/35)+1,this.player_hand_idx=l,this.svg=e,this.drag=t,this.status=n,"WILD"==this.char&&(this.status|=Tile.is_blank)}static get_Tile_json(){let e=[];return Tile.swapped_tiles.forEach((t=>{t&&e.push(t.get_JSON())})),e}get_JSON(){return{id:this.id,char:this.char,x:this.svg.getAttributeNS(null,"x"),y:this.svg.getAttributeNS(null,"y"),row:this.row,col:this.column,points:this.points,status:this.status,player_hand_idx:this.player_hand_idx}}move(e,t){this.row=e,this.column=t;let l=35*(t-1),n=35*(e-1);this.svg.setAttributeNS(null,"x",l),this.svg.setAttributeNS(null,"y",n),this.drag=this.drag.position(),Tile.is_on_board(e,t)?(this.status|=Tile.on_board,PlayerHand.remove(this)):PlayerHand.is_in_hand(l,n)&&(this.status&Tile.on_board&&(this.status^=Tile.on_board),PlayerHand.add(this)||console.log(`Cannot add tile ${this.char}/${this.id} to PlayerHand - tile may be dropped!`))}is_collision(e,t){let l=Tile.word_tiles.find(((l,n)=>{let i=l.getAttributeNS(null,"x"),a=l.getAttributeNS(null,"y"),r=Math.round(i/35)+1;return Math.round(a/35)+1==e&&r==t}));return!!l||(l=PlayStarts.find((l=>l!=this&&l.row==e&&l.column==t)),!!l||(AppOrientation==HORIZ&&(t<1||e>15)||AppOrientation==VERT&&(t>15||e<1))&&(console.log(`Tile.is_collision: collided with edge row/col: ${e}/${t}`),!0))}static word_tiles=[];static swapped_tiles=[];static none=0;static in_hand=1;static on_board=2;static is_blank=8;static utilized=32;static is_on_board(e,t){return e>0&&e<16&&t>0&&t<16}}class PlayerHand{constructor(){}static tiles=[];static squares=[{x:525+tiles_left_offset+10,y:player_hand_xy_offset+0},{x:525+tiles_left_offset+10,y:player_hand_xy_offset+70},{x:525+tiles_left_offset+10,y:player_hand_xy_offset+140},{x:525+tiles_left_offset+10,y:player_hand_xy_offset+210},{x:525+tiles_left_offset+10,y:player_hand_xy_offset+280},{x:525+tiles_left_offset+10,y:player_hand_xy_offset+350},{x:525+tiles_left_offset+10,y:player_hand_xy_offset+420}];static get_PlayerHand_json(){let e=[];return PlayerHand.tiles.forEach((t=>{t&&e.push(t.get_JSON())})),e}static set_tile_attrs(e,t,l){PlayerHand.tiles[e]&&(t&&e+l>=0&&e+l<7&&(PlayerHand.tiles[e].svg.setAttributeNS(null,"x",PlayerHand.squares[e+l].x),PlayerHand.tiles[e].svg.setAttributeNS(null,"y",PlayerHand.squares[e+l].y)),PlayerHand.tiles[e].player_hand_idx=e,PlayerHand.tiles[e].svg.setAttributeNS(null,"x",AppOrientation==HORIZ?PlayerHand.squares[e].x:PlayerHand.squares[e].y),PlayerHand.tiles[e].svg.setAttributeNS(null,"y",AppOrientation==HORIZ?PlayerHand.squares[e].y:PlayerHand.squares[e].x),PlayerHand.tiles[e].svg.setAttributeNS(null,"width",70),PlayerHand.tiles[e].svg.setAttributeNS(null,"height",70),PlayerHand.tiles[e].svg.setAttributeNS(null,"transfom",""),PlayerHand.tiles[e].drag=PlayerHand.tiles[e].drag.position())}static rearrange_hand(e,t){let l=PlayerHand.tiles.find(((t,l)=>(t&&t.svg==e&&t.player_hand_idx!=l&&(t.player_hand_idx=l),t&&t.svg==e)));l&&(PlayerHand.tiles[l.player_hand_idx]=null),l||(l=PlayStarts.find((t=>t&&t.svg==e)));let n=e.getAttributeNS(null,"x"),i=e.getAttributeNS(null,"y");if(t==l.player_hand_idx&&(AppOrientation==HORIZ?PlayerHand.squares.find(((e,l)=>{i>=e.y&&i<e.y+70&&(t=l)})):PlayerHand.squares.find(((e,l)=>{n>=e.y&&n<e.y+70&&(t=l)}))),l){PlayerHand.tiles;let e=PlayerHand.get_open_slot();if(console.log(`rearrange_hand tile x=${n} y=${i} os=${e} to_idx=${t}`),-1==e&&(e=l.player_hand_idx),e<t)for(let l=e;l<t;l++)PlayerHand.tiles[l]=PlayerHand.tiles[l+1],PlayerHand.set_tile_attrs(l,!0,-1);else if(e>t)for(let l=e;l>t;l--)PlayerHand.tiles[l]=PlayerHand.tiles[l-1],PlayerHand.set_tile_attrs(l,!0,1);PlayerHand.tiles[t]=l,PlayerHand.set_tile_attrs(t,!1,t)}}static is_in_hand(e,t){return AppOrientation==HORIZ&&e>525||AppOrientation==VERT&&t>525}static get_open_slot(){for(let e=0;e<PlayerHand.tiles.length;e++)if(!PlayerHand.tiles[e])return e;return-1}static remove(e){PlayerHand.tiles.forEach(((t,l)=>{t==e&&(PlayerHand.tiles[l]=null)}))}static add(e){let t=-1;if(!PlayerHand.tiles.find((t=>t&&t.id==e.id))&&-1!=(t=PlayerHand.get_open_slot())){PlayerHand.tiles[t]=e,e.status|=Tile.in_hand,e.status&Tile.on_board&&(e.status^=Tile.on_board),e.hand_idx=t;let l=AppOrientation==HORIZ?PlayerHand.squares[t].x:PlayerHand.squares[t].y,n=AppOrientation==HORIZ?PlayerHand.squares[t].y:PlayerHand.squares[t].x;return e.svg.setAttributeNS(null,"x",l),e.svg.setAttributeNS(null,"y",n),e.svg.setAttributeNS(null,"width",70),e.svg.setAttributeNS(null,"height",70),e.drag=e.drag.position(),!0}return!1}}var PlayStarts=[];function get_PlayStarts_JSON(){let e=[];return PlayStarts.forEach((t=>{t&&e.push(t.get_JSON())})),e}function svgToScreen(e){var t=e.getBoundingClientRect();return{x:t.left,y:t.top,width:t.width,height:t.height}}function screenToSVG(e,t,l){var n=e.createSVGPoint();n.x=t,n.y=l;var i=n.matrixTransform(e.getScreenCTM().inverse());return{x:Math.floor(i.x),y:Math.floor(i.y)}}function build_sub_struct(e,t,l,n){n||(n="tile_"),l.setAttributeNS(null,"id",n+e.id),-1==t?(l.setAttributeNS(null,"x",35*(e.column-1)),l.setAttributeNS(null,"y",35*(e.row-1)),l.setAttributeNS(null,"width",35),l.setAttributeNS(null,"height",35),"tile_"==n&&l.addEventListener("click",tile_clicked)):(l.setAttributeNS(null,"x",AppOrientation==HORIZ?PlayerHand.squares[t].x:PlayerHand.squares[t].y),l.setAttributeNS(null,"y",AppOrientation==HORIZ?PlayerHand.squares[t].y:PlayerHand.squares[t].x),l.setAttributeNS(null,"width",70),l.setAttributeNS(null,"height",70),"swap_"==n&&l.addEventListener("click",swap_tile_clicked)),l.setAttributeNS(null,"viewBox","0 0 35 35"),l.setAttributeNS(null,"fill","none");let i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttributeNS(null,"x",0),i.setAttributeNS(null,"y",0),i.setAttributeNS(null,"width",34),i.setAttributeNS(null,"height",34),i.setAttributeNS(null,"fill",e.fill),i.setAttributeNS(null,"stroke","#000"),i.setAttributeNS(null,"class","tile_rect"),l.append(i);let a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttributeNS(null,"x1",1),a.setAttributeNS(null,"y1",1),a.setAttributeNS(null,"x2",34),a.setAttributeNS(null,"y2",1),a.setAttributeNS(null,"stroke_width",1),a.setAttributeNS(null,"stroke","white"),a.setAttributeNS(null,"stroke-opacity",.4),a.setAttributeNS(null,"class","hilite_top_left"),l.append(a),a=document.createElementNS("http://www.w3.org/2000/svg","line"),a.setAttributeNS(null,"x1",1),a.setAttributeNS(null,"y1",1),a.setAttributeNS(null,"x2",1),a.setAttributeNS(null,"y2",33),a.setAttributeNS(null,"stroke_width",1),a.setAttributeNS(null,"stroke","white"),a.setAttributeNS(null,"stroke-opacity",.4),a.setAttributeNS(null,"class","hilite_top_left"),l.append(a),a=document.createElementNS("http://www.w3.org/2000/svg","line"),a.setAttributeNS(null,"x1",33),a.setAttributeNS(null,"y1",1),a.setAttributeNS(null,"x2",33),a.setAttributeNS(null,"y2",33),a.setAttributeNS(null,"stroke_width",1),a.setAttributeNS(null,"stroke","black"),a.setAttributeNS(null,"stroke-opacity",.4),a.setAttributeNS(null,"class","hilite_bottom_right"),l.append(a),a=document.createElementNS("http://www.w3.org/2000/svg","line"),a.setAttributeNS(null,"x1",1),a.setAttributeNS(null,"y1",33),a.setAttributeNS(null,"x2",33),a.setAttributeNS(null,"y2",33),a.setAttributeNS(null,"stroke_width",1),a.setAttributeNS(null,"stroke","black"),a.setAttributeNS(null,"stroke-opacity",.4),a.setAttributeNS(null,"class","hilite_bottom_right"),l.append(a);let r=document.createElementNS("http://www.w3.org/2000/svg","polygon");r.setAttributeNS(null,"points","3,3 15,3 3,15"),r.setAttributeNS(null,"fill","black"),e.status&Tile.is_blank||r.setAttributeNS(null,"fill-opacity","0"),l.append(r);let o=document.createElementNS("http://www.w3.org/2000/svg","text");o.setAttributeNS(null,"x",17.5),o.setAttributeNS(null,"y",17.5),o.setAttributeNS(null,"width",33),o.setAttributeNS(null,"height",33),o.setAttributeNS(null,"stroke_width",2),o.setAttributeNS(null,"stroke","#000"),o.setAttributeNS(null,"fill","#000"),o.setAttributeNS(null,"text-anchor","middle"),o.setAttributeNS(null,"alignment-baseline","central"),o.setAttributeNS(null,"class","tile_text"),"WILD"==e.char&&o.classList.add("wild_tile"),o.textContent=e.char,l.append(o);let s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttributeNS(null,"x",35-tile_points_offX),s.setAttributeNS(null,"y",35-tile_points_offY),s.setAttributeNS(null,"width",7),s.setAttributeNS(null,"height",7),s.setAttributeNS(null,"stroke_width",1),s.setAttributeNS(null,"stroke","#000"),o.setAttributeNS(null,"fill","#000"),s.setAttributeNS(null,"text-anchor","end"),s.setAttributeNS(null,"alignment-baseline","central"),s.setAttributeNS(null,"class","tile_points"),s.textContent=e.points,l.append(s)}function setup_jtile_for_play(e,t){let l=-1,n=document.createElementNS("http://www.w3.org/2000/svg","svg");if(n)if(t||(l=PlayerHand.get_open_slot(),n.setAttributeNS(null,"class","player_tile_svg")),build_sub_struct(e,l,n),PlaySpace.append(n),t)Tile.word_tiles.push(n);else{let t=new PlainDraggable(n);t.onMove=tile_moving,t.onDragEnd=tile_moved,t.onDragStart=tile_move_start,t.autoScroll=!0,t.containment={left:0,top:0,width:"100%",height:"100%"};let i=Tile.in_hand;e.status&Tile.is_blank&&(i|=Tile.is_blank),t.snap={CELL_SIZE:35},PlayerHand.tiles[l]=new Tile(n,t,l,i,e.points)}return n}function set_jtile_props(e){let t=document.getElementById("tile_"+e.id);if(t){t.childNodes[0].setAttributeNS(null,"fill",e.fill),t.classList.remove("player_tile_svg")}else t=setup_jtile_for_play(e,!0)}function get_played_JSONS(){document.querySelectorAll(".player_tile_svg");let e=[];return PlayStarts.forEach(((t,l)=>{e.push(t.get_JSON())})),e}function handle_err_response(e){let t=e[0].err_msg;alert(t)}function update_played_s_count(e){let t=document.querySelectorAll(".s_count");for(let l=0;l<e;l++)t[l].setAttributeNS(null,"stroke","white")}function update_scoreboard(e,t){let l=!0;return t.scoreboard_player_1_name?(e=document.getElementById("player1_name"))&&(e.textContent=t.scoreboard_player_1_name):void 0!==t.scoreboard_player_1_score?(e=document.getElementById("player1_score"))&&(e.textContent=t.scoreboard_player_1_score):void 0!==t.scoreboard_player_1_safe_score?(e=document.getElementById("player1_lock_pts"))&&(e.textContent=t.scoreboard_player_1_safe_score):t.scoreboard_player_2_name?(e=document.getElementById("player2_name"))&&(e.textContent=t.scoreboard_player_2_name):void 0!==t.scoreboard_player_2_score?(e=document.getElementById("player2_score"))&&(e.textContent=t.scoreboard_player_2_score):void 0!==t.scoreboard_player_2_safe_score?(e=document.getElementById("player2_lock_pts"))&&(e.textContent=t.scoreboard_player_2_safe_score):t.tiles_left_value>=0||t.tiles_left_value>=0?(e=document.getElementById("tiles_left_count"))&&(e.textContent=t.tiles_left_value):t.scoreboard_played_s_count>0?update_played_s_count(t.scoreboard_played_s_count):l=!1,l}function handle_the_response(e){var t=!1;if(e&&e[0]&&e[0].err_msg)handle_err_response(e),t=!0;else if(e&&e[0]){let l=e[0].new_data,n=e[0].word_tiles;for(let e=0;e<n.length;e++){let t=PlayStarts.find((t=>t.id=="tile_"+n[e].id));t&&(t.drag.remove(),t.svg.classList.remove("player_tile_svg"),t.svg.childNodes[0].setAttributeNS(null,"fill",n[e].fill),t.svg.addEventListener("click",tile_clicked),Tile.word_tiles.push(t.svg))}let i=null;for(let e=0;e<l.length;e++)update_scoreboard(i,l[e])||(l[e].play_data?l[e].play_data.forEach(((e,t)=>{set_jtile_props(e)})):l[e].new_tiles&&l[e].new_tiles.forEach(((e,t)=>{setup_jtile_for_play(e,!1)})));return t}return t||(Tile.word_tiles=[],tile_svgs=document.querySelectorAll(".word_tile_svg"),tile_svgs.forEach(((e,t)=>{Tile.word_tiles.push(e)})),PlayStarts=[]),t}var LastWordHilite=!1,HiliteWords=[];function clicked_hilite_last_word(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}if(LastWordHilite)return HiliteWords.forEach((e=>{e&&unhilite_tile(e)})),HiliteWords=[],void(LastWordHilite=!1);let t=[];t.unshift({player:URL_x}),t.unshift({type:"last_played_word"}),ws.send(JSON.stringify(t))}var ZoomOnTileDrag=!1;function clicked_toggle_zoom(e){ZoomOnTileDrag=!ZoomOnTileDrag}function clicked_play(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}if(current_player!=URL_x)return clicked_recall(),void alert("You are not the current player - please wait ...");let t=get_played_JSONS();t.unshift({type:"regular_play"}),t.length>1&&ws.send(JSON.stringify(t))}function get_player_hand_JSONS(){let e=[];return PlayerHand.tiles.forEach(((t,l)=>{e.push(t.get_JSON())})),e}function erase_player_hand(e){PlaySpace.getAttributeNS(null,"fill");for(let t=0;t<e.length;t++){let l=PlayerHand.tiles[e[t].player_hand_idx];l.svg.childNodes[0].setAttributeNS(null,"fill","white"),l.svg.childNodes[6].setAttributeNS(null,"stroke","white"),l.svg.childNodes[7].setAttributeNS(null,"stroke","white"),PlayerHand.tiles[e[t].player_hand_idx]=null}}function get_swap_JSONS(){var e=[];return Tile.swapped_tiles.forEach((t=>{let l="tile_"+parseInt(t.split("_")[2]),n=PlayerHand.tiles.find((e=>e.id==l));e.push(n.get_JSON())})),e}function clicked_recall(){PlayStarts.length>0&&PlayStarts.forEach((e=>{e.status&Tile.is_blank&&(e.svg.childNodes[6].textContent="WILD",e.svg.childNodes[6].setAttributeNS(null,"font-size","100%"),e.char="WILD",e.svg.childNodes[6].classList.add("wild_tile"),e.svg.childNodes[6].classList.remove("tile_text")),PlayerHand.add(e)||console.log(`clicked_recall: cannot add ${e.char}/${e.id} to PlayerHand`)})),PlayStarts=[]}function swap_toggle_highlight(e,t){var l=e.getAttributeNS(null,"id");let n=Tile.swapped_tiles.find((e=>e==l));if(n){if(!t){let t=Tile.swapped_tiles.indexOf(n);t>=0&&t<Tile.swapped_tiles.length&&(Tile.swapped_tiles=Tile.swapped_tiles.slice(0,t).concat(Tile.swapped_tiles.slice(t+1))),e.removeChild(e.lastChild)}}else{Tile.swapped_tiles.push(e.getAttributeNS(null,"id"));let t=document.createElementNS("http://www.w3.org/2000/svg","rect");t.setAttributeNS(null,"x",2),t.setAttributeNS(null,"y",2),t.setAttributeNS(null,"width",31),t.setAttributeNS(null,"height",31),t.setAttributeNS(null,"stroke","red"),t.setAttributeNS(null,"stroke-width","3"),e.appendChild(t)}}function swap_tile_clicked(e){swap_toggle_highlight(e.currentTarget)}function swap_select_all(e){console.log("in swap_select_all");let t=document.getElementById("swap_pop").getElementsByTagName("svg");for(i=0;i<t.length;i++){t[i].getAttributeNS(null,"id");swap_toggle_highlight(t[i],!0)}}function clicked_swap_cancel(e){let t=document.getElementById("swap_pop");for(t.style.display="none";t.firstChild;)t.removeChild(t.firstChild);Tile.swapped_tiles=[],window.onclick=null}function clicked_swap_begin(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}if(current_player!=URL_x)return clicked_recall(),void alert("You are not the current player - please wait ...");if(parseInt(document.getElementById("tiles_left_count").textContent)<11)return void alert("Tile swaps are limited to tile pool sizes of 10 or more - no swap!");let t=document.getElementById("swap_pop");if(t.firstChild)return void alert("Swap is already up! Cancel, Select All or Swap to continue.");let l=null,n="#000",i=-1;PlayerHand.tiles.forEach(((e,a)=>{l=document.createElementNS("http://www.w3.org/2000/svg","svg"),l&&(e.fill=e.svg.childNodes[0].getAttributeNS(null,"fill"),n=e.fill,build_sub_struct(e,a,l,"swap_"),t.appendChild(l),i=a)}));var a=document.createElement("BUTTON");a.id="swap_sel_all",a.textContent="Select All",a.width=70,a.height=35,a.onclick=swap_select_all,t.appendChild(a);var r=document.createElement("BUTTON");r.id="swap_now",r.textContent="Swap",r.width=70,r.height=35,r.onclick=clicked_swap_end,t.appendChild(r);var o=document.createElement("BUTTON");o.id="swap_cancel",o.textContent="Cancel",o.width=70,o.height=35,o.onclick=clicked_swap_cancel,t.appendChild(o),t.style.display="block"}function clicked_swap_end(e){let t=document.getElementById("swap_pop");for(t.style.display="none";t.firstChild;)t.removeChild(t.firstChild);let l=null,n=parseInt(document.getElementById("tiles_left_count").textContent);if(Tile.swapped_tiles.length>n)window.alert("Not enough tiles left to complete the play - THIS IS A PASS"),clicked_recall(),l=[{type:"pass"}];else if(7==Tile.swapped_tiles.length&&window.confirm("Are you sure you want to trade all of your tiles?"))l=get_player_hand_JSONS(),erase_player_hand(l);else{if(!(Tile.swapped_tiles.length>0))return;window.confirm("Are you sure you want to trade "+Tile.swapped_tiles.length+" of your tiles?")?(l=get_swap_JSONS(),erase_player_hand(l)):clicked_recall()}Tile.swapped_tiles=[],l.length>0&&(l[0].type||l.unshift({type:"xchange"}),ws.send(JSON.stringify(l)))}function clicked_tail_log_btn(){var e=ChatDoc.getElementById("log_name").value,t=document.getElementById("user").value;if(t){let l=[];l.push({type:"tail_log"}),l.push({player:t}),l.push({info:e}),ws.send(JSON.stringify(l))}}function clicked_cheat_send_btn(e){var t=ChatDoc.getElementById("cheat_text"),l=document.getElementById("user").value;if(t&&l){let e=[];e.push({type:"cheat"}),e.push({player:l}),e.push({info:t.value}),ws.send(JSON.stringify(e))}}function clicked_peek_board_btn(){let e=[];e.push({Tile:Tile.get_Tile_json()}),e.push({PlayerHand:PlayerHand.get_PlayerHand_json()}),e.push({PlayStarts:get_PlayStarts_JSON()});var t=ChatDoc.getElementById("chat_text");jsonTree.create(e,t)}function clicked_chat_btn(){if(ChatWin)return;let e=window.screenLeft>chat_width?window.screenLeft-chat_width:window.outerWidth;(ChatWin=window.open("","Chat",`width=${chat_width},height=${chat_height},popup,left=${e}`)).addEventListener("unload",(e=>{ChatWin=null}));let t=(ChatDoc=ChatWin.document).createElement("div");t.id="chat_text",t.height="80%",t.width="100%";let l=ChatDoc.createElement("div");l.id="ctrls",l.height="20%",l.width="100%";let n=ChatDoc.createElement("p");n.id="chat_para",n.x="0",n.y="0",n.height="260",n.width="100%",n.textContent="<b>Salutations Worderists!</b>",t.appendChild(n);let i=ChatDoc.createElement("textarea");i.id="chat_send_text",i.x="0",i.y="80%",i.rows="2",i.cols="30",i.wrap="hard",i.placeholder="Type here ...",l.appendChild(i);let a=ChatDoc.createElement("input");a.id="chat_send_btn",a.type="button",a.class="button",a.value="Send",a.height="30",a.width="50",a.onclick=clicked_chat_send_btn,l.appendChild(a),"true"==is_admin&&(i=document.createElement("textarea"),i.id="cheat_text",i.rows="2",i.cols="30",i.wrap="soft",i.placeholder="Cheat here ...",l.appendChild(i),a=ChatDoc.createElement("input"),a.id="cheat_send_btn",a.type="button",a.class="button",a.value="Send",a.height="30",a.width="50",a.onclick=clicked_cheat_send_btn,l.appendChild(a),a=ChatDoc.createElement("input"),a.id="peek_board_btn",a.type="button",a.class="button",a.value="Peek",a.height="30",a.width="50",a.onclick=clicked_peek_board_btn,l.appendChild(a),i=document.createElement("textarea"),i.id="log_name",i.rows="1",i.cols="30",i.wrap="soft",i.placeholder="tail-file path/name ...",l.appendChild(i),a=ChatDoc.createElement("input"),a.id="tail_log_btn",a.type="button",a.class="button",a.value="Send",a.height="30",a.width="50",a.onclick=clicked_tail_log_btn,l.appendChild(a)),ChatDoc.body.appendChild(t),ChatDoc.body.appendChild(l),Chat=ChatDoc.getElementById("chat_para")}function clicked_chat_send_btn(e){let t=ChatDoc.getElementById("chat_send_text");var l=document.getElementById("user").value;if(t&&l){let e=[];e.push({type:"chat"}),e.push({player:l}),e.push({info:t.value}),t.value="",ws.send(JSON.stringify(e))}}function clicked_home_btn(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}let t=document.getElementById("current_game_id").value;var l=document.getElementById("user").value;let n=new XMLHttpRequest;n.open("GET",URL_x+"/home_page?game="+t+"&user="+l,!0),n.setRequestHeader("Content-Type","text/html"),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(document.location.href="/home_page?user="+l,console.log("home_btn.callback: port: "+ws_port))},ChatWin&&(ChatWin.close(),ChatWin=null),console.log("clicked_home_btn port: "+ws_port),n.send(null)}function clicked_question(e){alert("Nothing to see here. Move along.")}function clicked_bookmark_log(e){if(BookMKWin)return;let t=window.screenLeft>BookMK_width?window.screenLeft-BookMK_width:window.outerWidth;(BookMKWin=window.open("","Bookmark Log",`width=${BookMK_width},height=${BookMK_height},popup,left=${t}`)).addEventListener("unload",(e=>{BookMKWin=null}));let l=(BookMKDoc=BookMKWin.document).createElement("div");l.id="bookmk_text",l.height="80%",l.width="100%";let n=BookMKDoc.createElement("div");n.id="ctrls",n.height="20%",n.width="100%";let i=BookMKDoc.createElement("p");i.id="bookmk_para",i.x="0",i.y="0",i.height="260",i.width="100%",i.textContent="Enter as much info about this heinous event as you can - words played, tiles which should be somewhere else, etc.",l.appendChild(i);let a=BookMKDoc.createElement("textarea");a.id="bookmk_send_text",a.x="0",a.y="80%",a.rows="10",a.cols="30",a.wrap="hard",a.placeholder="Complain here ...",n.appendChild(a);let r=BookMKDoc.createElement("input");r.id="bookmk_send_btn",r.type="button",r.class="button",r.value="Send",r.height="30",r.width="50",r.onclick=clicked_bookmk_send_btn,n.appendChild(r),BookMKDoc.body.appendChild(l),BookMKDoc.body.appendChild(n),BookMK=BookMKDoc.getElementById("bookmk_para")}function clicked_bookmk_send_btn(e){let t=BookMKDoc.getElementById("bookmk_send_text");var l=document.getElementById("user").value;if(t&&l){let e=[];e.push({type:"bookmark_log"}),e.push({player:l}),e.push({info:t.value}),t.value="",ws.send(JSON.stringify(e)),BookMKWin&&(BookMKWin.close(),BookMKWin=null)}}function clicked_pass(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}if(current_player!=URL_x)return clicked_recall(),void alert("You are not the current player - please wait ...");clicked_recall(),jsons=[{type:"pass"}],ws.send(JSON.stringify(jsons))}var FullVertVB=`0 0 525 ${525+player_panel_wh}`,ViewStack=[FullVertVB];const vb_wide=315,vb_heigh=315*(525+player_panel_wh)/525;function magnify_view(e,t,l){let n,i,a,r=0,o=null;ViewStack.length>1?(o=ViewStack[ViewStack.length-1].split(" "),n=parseInt(o[0]),i=parseInt(o[1])):(n=Math.max(t-157.5,0),n=Math.min(n,210),i=Math.max(l-vb_heigh/2,0),i=Math.min(i,525+player_panel_wh-vb_heigh-35)),a=n+315,r=i+vb_heigh,a<525&&t>a-70?n+=10:r<525+player_panel_wh&&l>r-70?i+=10:n>0&&t<n+70?n-=10:i>0&&l<i+70&&(i-=10);let s=`${n} ${i} 315 ${vb_heigh}`;console.log(`magnify_view x/y: ${t}/${l} vbstr - ${s}`),s!=ViewStack[length-1]&&(ViewStack.length>1&&ViewStack.pop(),ViewStack.push(s),PlaySpace.setAttributeNS(null,"viewBox",s),e.drag.position())}function reset_view(e){ViewStack.length>1&&ViewStack.pop();let t=ViewStack[0];PlaySpace.setAttributeNS(null,"viewBox",t),e.drag.position()}function tile_clicked(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}let t=this.id.split("_"),l=parseInt(t[1]),n=[];n.push({type:"dictionary_lookup"}),n.push({player:URL_x}),n.push({info:l}),ws.send(JSON.stringify(n))}function tile_move_start(e){let t=this.element,l=PlayStarts.find((e=>e&&e.svg==t));l||(l=PlayerHand.tiles.find((e=>e&&e.svg==t)),l&&PlayStarts.push(l))}function tile_moving(e){let t=-1,l=-1,n=this.element,i=screenToSVG(PlaySpace,e.left,e.top);console.log(`tile_moving 2screen: ${i.x},${i.y}`);let a=i.x,r=i.y;t=Math.round(r/35+1),l=Math.round(a/35+1),console.log(`r/c from drag: ${t},${l}`);let o=PlayerHand.tiles.find((e=>e&&e.svg==n));o||(o=PlayStarts.find((e=>e&&e.svg==n))),r=35*(l-1),a=35*(t-1),AppOrientation==VERT&&ZoomOnTileDrag&&magnify_view(o,r,a),PlayerHand.is_in_hand(r,a)?PlayerHand.rearrange_hand(n,o.player_hand_idx):o&&o.is_collision(t,l)?(t=o.row,l=o.column):Tile.is_on_board(t,l)&&(n.setAttributeNS(null,"width",35),n.setAttributeNS(null,"height",35),o&&o.is_collision(t,l)&&(t=o.row,l=o.column)),o&&(o.row=t,o.column=l),r=35*(l-1),a=35*(t-1),n.setAttributeNS(null,"transform",""),n.setAttributeNS(null,"x",r),n.setAttributeNS(null,"y",a),this.position()}function tile_moved(e){var t,l=-1,n=-1;let i=this.element,a=i.getAttributeNS(null,"x"),r=i.getAttributeNS(null,"y"),o=PlayerHand.tiles.find((e=>e&&e.svg==i));if(AppOrientation==VERT&&ZoomOnTileDrag&&reset_view(o),o||(o=PlayStarts.find((e=>e&&e.svg==i))),o)if(AppOrientation==HORIZ?(o.drag.left-=grid_offset_xy-70,e.left-=grid_offset_xy-70):(o.drag.top+=grid_offset_xy+70,e.top+=grid_offset_xy+70),o.drag.position(),n=Math.round(a/35)+1,l=Math.round(r/35)+1,o.is_collision(l,n)?(l=o.row,n=o.column):o.move(l,n),PlayerHand.is_in_hand(a,r))PlayerHand.rearrange_hand(o.svg,o.player_hand_idx),PlayStarts=PlayStarts.filter((e=>e.id!=o.id));else if(Tile.is_on_board(l,n)){if(o.status|=Tile.on_board,PlayerHand.remove(o),o.status&Tile.is_blank&&"WILD"==o.char&&(t=window.prompt("Please type the letter to use: "))){for(;!char_regex.test(t);)t=window.prompt("A SINGLE CHARACTER a-z or A-Z - EXCEPT S- is acceptable! OR - \nA SINGLE CHARACHTER a/A-r/R or t/T - z/Z. NO s/S");o.char=t.trim().toUpperCase(),i.childNodes[6].textContent=o.char,i.childNodes[6].setAttributeNS(null,"font-size","100%"),i.childNodes[6].classList.remove("wild_tile"),i.childNodes[6].classList.add("tile_text")}}else PlayerHand.rearrange_hand(o.svg,o.player_hand_idx)}function setup_svgtiles_for_drag(){let e=document.querySelectorAll(".player_tile_svg");e.forEach(((e,t)=>{e.setAttributeNS(null,"width",70),e.setAttributeNS(null,"height",70);let l=new PlainDraggable(e);l.onMove=tile_moving,l.onDragEnd=tile_moved,l.onDragStart=tile_move_start,l.autoScroll=!0,l.containment={left:0,top:0,width:"100%",height:"100%"},l.snap={CELL_SIZE:35},PlayerHand.tiles.push(new Tile(e,l,t,Tile.in_hand))})),Tile.word_tiles=[],e=document.querySelectorAll(".word_tile_svg"),e.forEach(((e,t)=>{Tile.word_tiles.push(e)}))}function update_the_board(e){if(!e[0].err_msg){let t=e[0].new_data,l=(e[0].word_tiles,null);for(let e=0;e<t.length;e++)update_scoreboard(l,t[e])||t[e].play_data&&t[e].play_data.forEach(((e,t)=>{set_jtile_props(e)}))}}function handle_exchange(e){let t=e[0].new_data,l=e[0].xchanged_tiles;for(let e=0;e<t.length;e++){let l;update_scoreboard(l,t[e])}l.forEach(((e,t)=>{setup_jtile_for_play(e,!1)}))}function handle_pass(e){for(let t=0;t<e[0].new_data.length;t++){let l;update_scoreboard(l,e[0].new_data[t])}}function toggle_player(){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player2":"/player1";let t=document.getElementById("current_game_id").value,l=document.getElementById("user").value,n=new XMLHttpRequest;n.open("GET",URL_x+"?game="+t+"&user="+l,!0),n.setRequestHeader("Content-Type","text/html"),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(document.location.href=URL_x+"?game="+t+"&user="+l)},ChatWin&&(ChatWin.close(),ChatWin=null),n.send(null)}function hilite_tile(e){e&&(e.childNodes[0].setAttributeNS(null,"x",2),e.childNodes[0].setAttributeNS(null,"y",2),e.childNodes[0].setAttributeNS(null,"width",31),e.childNodes[0].setAttributeNS(null,"height",31),e.childNodes[0].setAttributeNS(null,"stroke","white"),e.childNodes[0].setAttributeNS(null,"stroke-width","3"))}function unhilite_tile(e){e&&(e.childNodes[0].setAttributeNS(null,"x",0),e.childNodes[0].setAttributeNS(null,"y",0),e.childNodes[0].setAttributeNS(null,"width",35),e.childNodes[0].setAttributeNS(null,"height",35),e.childNodes[0].setAttributeNS(null,"stroke","black"),e.childNodes[0].setAttributeNS(null,"stroke-width","1"))}function handle_dictionary_lookup(e){let t,l="";for(let n=0;n<e.length;n++)if(e[n].word)t=e[n].word;else if(e[n].definitions)for(let i=0;i<e[n].definitions.length;i++)e[n].definitions[i].partOfSpeech?l+=`${t} : ${e[n].definitions[i].partOfSpeech}\n`:e[n].definitions[i].definitions&&e[n].definitions[i].definitions.forEach(((e,t)=>{l+=`${t+1}: ${e}\n`}));l+="\nDefinitions courtesy of Free Dictionary API",alert(l)}function handle_last_played_word(e,t){LastWordHilite=!0;let l=null;t.forEach((e=>{l=Tile.word_tiles.find((t=>t.id=="tile_"+e.id)),l&&(hilite_tile(l),HiliteWords.push(l))}))}function handle_tail_log(e,t){let l=t.split("\n");Chat.innerHTML+="<br><b>"+e+"</b>:<br>";for(let e=0;e<l.length;e++)Chat.innerHTML+=l[e]+" <br>"}function handle_cheat(e,t){let l=t.split("\n");Chat.innerHTML+="<br><b>"+e+"</b>:<br>";for(let e=0;e<l.length;e++){let t=l[e].indexOf(":");Chat.innerHTML+=l[e].slice(-(l[e].length-t-1))+"<br>"}}function handle_chat(e,t){Chat.innerHTML+="<br><b>"+e+"</b>:<br>"+t}function handle_game_over(e){var t="Final Score: "+e.player1.name+": ",l="Final Score: "+e.player2.name+": ",n=[];e.player1.remaining_tiles.forEach(((e,t)=>{n.push(e.char+"/"+e.points)})),t+=e.player1.score+"\nUnplayed tiles: \n"+n.join(" ");var i=[];e.player2.remaining_tiles.forEach(((e,t)=>{i.push(e.char+"/"+e.points)})),l+=e.player2.score+"\nUnplayed tiles: \n"+i.join(" "),window.alert("GAME OVER!\n\n"+t+"\n\n"+l)}const HORIZ=0,VERT=1;AppOrientation=VERT,AppSpace=document.querySelectorAll("#every_damn_thing")[0],PlaySpace=document.querySelectorAll("#wt_board")[0];const ws=new WebSocket("ws://dbc-games.com:"+ws_port);function update_current_player(e){if("/player1"==(current_player=-1!=e.indexOf("player1")?"/player2":"/player1")){let e=document.getElementById("player1_photo");e.setAttributeNS(null,"stroke","red"),e.setAttributeNS(null,"stroke-width","3"),e=document.getElementById("player2_photo"),e.setAttributeNS(null,"stroke-width","0")}else{let e=document.getElementById("player2_photo");e.setAttributeNS(null,"stroke","red"),e.setAttributeNS(null,"stroke-width","3"),e=document.getElementById("player1_photo"),e.setAttributeNS(null,"stroke-width","0")}}function set_button_callbacks(){let e=document.getElementById("back_on_click");e&&e.addEventListener("click",clicked_home_btn),e=document.getElementById("question_click"),e&&e.addEventListener("click",clicked_question),e=document.getElementById("player2_photo"),e&&e.addEventListener("click",clicked_toggle_zoom),e=document.getElementById("last_played_on_click"),e&&e.addEventListener("click",clicked_hilite_last_word),e=document.getElementById("bookmark_log"),e&&e.addEventListener("click",clicked_bookmark_log),e=document.getElementById("recall_on_click"),e&&e.addEventListener("click",clicked_recall),e=document.getElementById("play_on_click"),e&&e.addEventListener("click",clicked_play),e=document.getElementById("pass_on_click"),e&&e.addEventListener("click",clicked_pass),e=document.getElementById("swap_on_click"),e&&e.addEventListener("click",clicked_swap_begin),e=document.getElementById("player1_photo"),e&&e.addEventListener("click",clicked_chat_btn)}function set_word_tile_click(){document.querySelectorAll(".tilehook").forEach((e=>{e.addEventListener("click",tile_clicked)}))}ws.onmessage=function(e){if(!URL_x){let e=window.location.href;URL_x=e.indexOf("player1")>-1?"/player1":"/player2"}let t=!1,l=JSON.parse(e.data),n=l.shift(),i=l.shift(),a=l.shift();if("game_over"==n.type)handle_game_over(a);else if("pass"==n.type)i.player!=URL_x&&alert(a.info),handle_pass(l),update_current_player(i.player);else if("xchange"==n.type)if(i.player==URL_x)handle_exchange(l),update_current_player(i.player);else{let e=l[0].new_data;for(let t=0;t<e.length;t++){let l;update_scoreboard(l,e[t])}alert(a.info)}else"regular_play"==n.type?i.player==URL_x?(t=handle_the_response(l))||update_current_player(i.player):(update_the_board(l),l[0].err_msg||update_current_player(i.player),"none"!=a.info&&alert(a.info)):"message"==n.type?i.player!=URL_x&&alert(a.info):"chat"==n.type?handle_chat(i.player,a.info):"cheat"==n.type?handle_cheat(i.player,a.info):"tail_log"==n.type?handle_tail_log(i.player,a.info):"last_played_word"==n.type?i.player==URL_x&&handle_last_played_word(i.player,a.tiles):"dictionary_lookup"==n.type?i.player==URL_x&&handle_dictionary_lookup(l):console.log("in onmessage: no play type");t||(PlayStarts=[]),"0"==is_practice||t||"chat"==n.type||"cheat"==n.type||"tail_log"==n.type||"last_played_word"==n.type||"dictionary_lookup"==n.type||toggle_player()},ws.onopen=function(){},ws.onerror=function(e){console.error("in get socket: error "+e)},ws.onclose=function(e){console.log("in get socket: close "+e)},set_button_callbacks(),set_word_tile_click(),setup_svgtiles_for_drag();